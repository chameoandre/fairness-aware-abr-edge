FROM debian:bullseye-slim

# Variáveis de versão
ENV NGINX_VERSION 1.21.6
ENV STICKY_MODULE_VERSION 1.2.6

# Instala dependências necessárias para a construção
RUN apt-get update && apt-get install -y \
    build-essential \
    libpcre3 \
    libpcre3-dev \
    zlib1g \
    zlib1g-dev \
    libssl-dev \
    wget \
    curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Baixa o código-fonte do Nginx
RUN wget http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz \
    && tar -zxvf nginx-${NGINX_VERSION}.tar.gz

# Baixa o código-fonte do módulo sticky
RUN wget https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/get/${STICKY_MODULE_VERSION}.tar.gz \
    && tar -zxvf ${STICKY_MODULE_VERSION}.tar.gz

# Constrói o Nginx com o módulo sticky
WORKDIR nginx-${NGINX_VERSION}
RUN ./configure \
    --with-compat \
    --add-dynamic-module=../nginx-goodies-nginx-sticky-module-ng-* \
    && make \
    && make install

# Configura o Nginx
RUN ln -s /usr/local/nginx/sbin/nginx /usr/sbin/nginx \
    && mkdir -p /etc/nginx/conf.d \
    && mkdir -p /var/log/nginx \
    && mkdir -p /usr/share/nginx/html

# Copia os arquivos de configuração do Nginx
COPY ./conf.d/load_balancer.conf /etc/nginx/conf.d/default.conf

# Define as portas expostas
EXPOSE 80

# Comando para iniciar o Nginx
CMD ["nginx", "-g", "daemon off;"]
